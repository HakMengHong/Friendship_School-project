'use client'

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { RoleGuard } from "@/components/ui/role-guard"
import { 
  Users, 
  BookOpen, 
  Award, 
  MessageSquare, 
  Star, 
  TrendingUp, 
  Activity, 
  Trash2 as TrashIcon,
  Plus,
  BarChart3,
  UserCheck,
  Clock,
  CheckCircle,
  XCircle,
  UserPlus,
  GraduationCap
} from "lucide-react"
import { KhmerCalendar } from "@/components/calendar/khmer_calendar"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Badge } from "@/components/ui/badge"
import { useState, useEffect } from "react"
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts'
import { Loader2, AlertCircle } from "lucide-react"

export default function DashboardPage() {
  return (
    <RoleGuard allowedRoles={['admin']}>
      <DashboardContent />
    </RoleGuard>
  )
}

function DashboardContent() {
  // Database interfaces
  interface Student {
    studentId: number
    firstName: string
    lastName: string
    class: string
    status: string
  }

  interface User {
    userId: number
    firstname: string
    lastname: string
    role: string
    status: string
  }

  interface Course {
    courseId: number
    courseName: string
    grade: string
    section: string
  }

  interface Attendance {
    attendanceId: number
    status: string
    attendanceDate: string
  }

  // State for real data
  const [students, setStudents] = useState<Student[]>([])
  const [users, setUsers] = useState<User[]>([])
  const [courses, setCourses] = useState<Course[]>([])
  const [attendances, setAttendances] = useState<Attendance[]>([])
  
  // Loading and error states
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  // State for announcements
  const [announcements, setAnnouncements] = useState([
    { id: "1", title: "·ûÄ·û∂·ûö·ûî·üí·ûö·ûá·ûª·üÜ·ûÇ·üí·ûö·ûº", content: "·ûò·û∂·ûì·ûÄ·û∂·ûö·ûî·üí·ûö·ûá·ûª·üÜ·ûÇ·üí·ûö·ûº·ûì·üÖ·ûê·üí·ûÑ·üÉ·ûü·üÖ·ûö·üç·ûì·üÅ·üá ·ûì·üÖ·ûò·üâ·üÑ·ûÑ ·ü®:·ü†·ü† ·ûñ·üí·ûö·ûπ·ûÄ", date: "2024-01-15", author: "·û¢·üí·ûì·ûÄ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ", priority: "high" },
    { id: "2", title: "·ûÄ·û∂·ûö·ûî·üí·ûö·û°·ûÑ·ûÜ·ûò·û∂·ûü", content: "·ûÄ·û∂·ûö·ûî·üí·ûö·û°·ûÑ·ûÜ·ûò·û∂·ûü·ûì·ûπ·ûÑ·ûÖ·û∂·ûî·üã·ûï·üí·ûè·ûæ·ûò·ûì·üÖ·ûÅ·üÇ·ûÄ·üí·ûö·üÑ·ûô ·ûü·ûº·ûò·ûÇ·üí·ûö·ûº·ûö·üÄ·ûî·ûÖ·üÜ·ûü·û∑·ûü·üí·ûü", date: "2024-01-10", author: "·û¢·üí·ûì·ûÄ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ", priority: "medium" },
    { id: "3", title: "·ûÄ·û∂·ûö·ûî·üí·ûö·ûÄ·ûΩ·ûè·û¢·ûÄ·üí·ûü·ûö·ûü·û∂·ûü·üí·ûè·üí·ûö", content: "·ûì·ûπ·ûÑ·ûò·û∂·ûì·ûÄ·û∂·ûö·ûî·üí·ûö·ûÄ·ûΩ·ûè·û¢·ûÄ·üí·ûü·ûö·ûü·û∂·ûü·üí·ûè·üí·ûö·ûì·üÖ·ûê·üí·ûÑ·üÉ·ûñ·ûª·ûí ·ûü·ûº·ûò·ûÇ·üí·ûö·ûº·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûü·û∑·ûü·üí·ûü", date: "2024-01-08", author: "·û¢·üí·ûì·ûÄ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ", priority: "low" },
  ])

  // State for outstanding students
  const [outstandingStudents] = useState([
    { id: 1, name: "·ûü·ûª·ûÅ ·ûü·üÜ·û¢·û∂·ûÑ", grade: "·ûê·üí·ûì·û∂·ûÄ·üã·ûë·û∏·ü°·ü¢·ûÄ", achievement: "·ûñ·û∑·ûì·üí·ûë·ûª·ûÅ·üí·ûñ·ûü·üã·ûî·üÜ·ûï·ûª·ûè·ûÄ·üí·ûì·ûª·ûÑ·ûê·üí·ûì·û∂·ûÄ·üã", score: "A+", subject: "·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂" },
    { id: 2, name: "·ûò·üâ·üÖ ·ûü·ûª·ûí·û∂·ûö·û∏", grade: "·ûê·üí·ûì·û∂·ûÄ·üã·ûë·û∏·ü°·ü°·ûÅ", achievement: "·ûà·üí·ûì·üá·ûÄ·û∂·ûö·ûî·üí·ûö·ûÄ·ûΩ·ûè·û¢·ûÄ·üí·ûü·ûö·ûü·û∂·ûü·üí·ûè·üí·ûö", score: "A+", subject: "·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö" },
    { id: 3, name: "·ûú·üâ·û∂·ûì·üã ·ûü·ûª·ûï·ûõ", grade: "·ûê·üí·ûì·û∂·ûÄ·üã·ûë·û∏·ü°·ü†·ûÇ", achievement: "·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ·ûü·üí·ûò·üê·ûÇ·üí·ûö·ûÖ·û∑·ûè·üí·ûè·ûõ·üí·û¢", score: "A", subject: "·ûú·û∑·ûë·üí·ûô·û∂·ûü·û∂·ûü·üí·ûè·üí·ûö" },
    { id: 4, name: "·ûÇ·ûπ·ûò ·ûü·ûª·ûÅ·û∂", grade: "·ûê·üí·ûì·û∂·ûÄ·üã·ûë·û∏·ü°·ü¢·ûÅ", achievement: "·ûñ·û∑·ûì·üí·ûë·ûª·ûõ·üí·û¢·ûÄ·üí·ûì·ûª·ûÑ·ûÇ·üí·ûö·ûî·üã·ûò·ûª·ûÅ·ûú·û∑·ûá·üí·ûá·û∂", score: "A", subject: "·ûÇ·üí·ûö·ûî·üã·ûò·ûª·ûÅ·ûú·û∑·ûá·üí·ûá·û∂" },
  ])

  // Learning quality data by month
  const learningQualityData = [
    { month: '·ûò·ûÄ·ûö·û∂', quality: 75, averageScore: 68, attendance: 92 },
    { month: '·ûÄ·ûª·ûò·üí·ûó·üà', quality: 82, averageScore: 72, attendance: 89 },
    { month: '·ûò·û∏·ûì·û∂', quality: 78, averageScore: 70, attendance: 91 },
    { month: '·ûò·üÅ·ûü·û∂', quality: 85, averageScore: 75, attendance: 94 },
    { month: '·ûß·ûü·ûó·û∂', quality: 90, averageScore: 80, attendance: 96 },
    { month: '·ûò·û∑·ûê·ûª·ûì·û∂', quality: 88, averageScore: 78, attendance: 93 },
  ]

  // Attendance data for pie chart
  const attendanceData = [
    { name: '·ûò·û∂·ûì', value: 1150, color: '#10b981' },
    { name: '·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì', value: 45, color: '#ef4444' },
    { name: '·ûô·û∫·ûè·ûô·üâ·û∂·ûú', value: 23, color: '#f59e0b' },
    { name: '·ûÖ·üí·ûî·û∂·ûî·üã', value: 12, color: '#3b82f6' },
  ]

  // Recent activities
  const recentActivities = [
    { id: 1, action: "·ûî·û∂·ûì·ûî·ûì·üí·ûê·üÇ·ûò·ûü·û∑·ûü·üí·ûü·ûê·üí·ûò·û∏", time: "·ü¢ ·ûì·û∂·ûë·û∏·ûò·ûª·ûì", type: "add", user: "·ûÇ·üí·ûö·ûº ·ûü·ûª·ûÅ·û∂" },
    { id: 2, action: "·ûî·û∂·ûì·ûÄ·üÇ·ûî·üí·ûö·üÇ·ûñ·û∑·ûì·üí·ûë·ûª", time: "·ü• ·ûì·û∂·ûë·û∏·ûò·ûª·ûì", type: "edit", user: "·ûÇ·üí·ûö·ûº ·ûò·üâ·üÖ" },
    { id: 3, action: "·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûê·üí·ûì·û∂·ûÄ·üã·ûê·üí·ûò·û∏", time: "·ü°·ü† ·ûì·û∂·ûë·û∏·ûò·ûª·ûì", type: "create", user: "·û¢·üí·ûì·ûÄ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ" },
    { id: 4, action: "·ûî·û∂·ûì·ûî·ûâ·üí·ûÖ·ûº·ûõ·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì", time: "·ü°·ü• ·ûì·û∂·ûë·û∏·ûò·ûª·ûì", type: "attendance", user: "·ûÇ·üí·ûö·ûº ·ûú·ûÑ·üí·ûü" },
    { id: 5, action: "·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûä·üÜ·ûé·ûπ·ûÑ", time: "·ü¢·ü† ·ûì·û∂·ûë·û∏·ûò·ûª·ûì", type: "announcement", user: "·û¢·üí·ûì·ûÄ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ" },
  ]

  // Announcement form state
  const [showAddForm, setShowAddForm] = useState(false);
  const [newAnnouncement, setNewAnnouncement] = useState({
    title: '',
    content: '',
    author: '',
    date: '',
    priority: 'medium'
  });
  
  const handleAddAnnouncement = () => {
    if (!newAnnouncement.title || !newAnnouncement.content) return;
    
    const announcementToAdd = {
      ...newAnnouncement,
      id: Date.now().toString(),
      date: new Date().toISOString().split('T')[0]
    };
    
    setAnnouncements([announcementToAdd, ...announcements]);
    
    // Reset form
    setNewAnnouncement({
      title: '',
      content: '',
      author: '',
      date: '',
      priority: 'medium'
    });
    setShowAddForm(false);
  };
  
  const handleDeleteAnnouncement = (id: string) => {
    setAnnouncements(announcements.filter(announcement => announcement.id !== id));
  };

  // Fetch data from database
  useEffect(() => {
    fetchDashboardData()
  }, [])

  const fetchDashboardData = async () => {
    try {
      setLoading(true)
      setError(null)

      // Fetch all data in parallel
      const [studentsRes, usersRes, coursesRes, attendancesRes] = await Promise.all([
        fetch('/api/students'),
        fetch('/api/users'),
        fetch('/api/courses'),
        fetch('/api/attendance?date=' + new Date().toISOString().split('T')[0])
      ])

      // Check responses and parse data
      if (!studentsRes.ok) throw new Error(`Failed to fetch students: ${studentsRes.status}`)
      if (!usersRes.ok) throw new Error(`Failed to fetch users: ${usersRes.status}`)
      if (!coursesRes.ok) throw new Error(`Failed to fetch courses: ${coursesRes.status}`)
      if (!attendancesRes.ok) throw new Error(`Failed to fetch attendances: ${attendancesRes.status}`)

      const [studentsData, usersData, coursesData, attendancesData] = await Promise.all([
        studentsRes.json(),
        usersRes.json(),
        coursesRes.json(),
        attendancesRes.json()
      ])

      setStudents(studentsData)
      setUsers(usersData.users || [])
      setCourses(coursesData)
      setAttendances(attendancesData)

      console.log('‚úÖ Dashboard data loaded successfully')
      console.log('üìä Students:', studentsData?.length || 0)
      console.log('üë• Users:', usersData?.users?.length || 0)
      console.log('üìö Courses:', coursesData?.length || 0)
      console.log('üìÖ Attendances:', attendancesData?.length || 0)
    } catch (error) {
      console.error('Error fetching dashboard data:', error)
      setError(error instanceof Error ? error.message : 'Failed to fetch dashboard data')
    } finally {
      setLoading(false)
    }
  }

  // Safety check for users array
  const safeUsers = users || []

  // Calculate real-time statistics
  const dashboardStats = {
    totalStudents: students.length,
    totalTeachers: safeUsers.filter(user => user.role === 'TEACHER').length,
    totalCourses: courses.length,
    totalAnnouncements: announcements.length,
    activeStudents: students.filter(student => student.status === 'ACTIVE').length,
    todayAttendance: attendances.length,
    presentToday: attendances.filter(a => a.status === 'present').length,
    absentToday: attendances.filter(a => a.status === 'absent').length,
    lateToday: attendances.filter(a => a.status === 'late').length,
    excusedToday: attendances.filter(a => a.status === 'excused').length
  }

  // Generate real attendance data for pie chart
  const realAttendanceData = [
    { name: '·ûú·ûè·üí·ûè·ûò·û∂·ûì', value: dashboardStats.presentToday, color: '#10b981' },
    { name: '·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì', value: dashboardStats.absentToday, color: '#ef4444' },
    { name: '·ûô·û∫·ûè', value: dashboardStats.lateToday, color: '#f59e0b' },
    { name: '·ûÖ·üí·ûî·û∂·ûî·üã', value: dashboardStats.excusedToday, color: '#3b82f6' },
  ]

  const getPriorityBadge = (priority: string) => {
    switch (priority) {
      case 'high':
        return <Badge className="bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400">·ûü·üÜ·ûÅ·û∂·ûì·üã</Badge>
      case 'medium':
        return <Badge className="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400">·ûí·ûò·üí·ûò·ûè·û∂</Badge>
      case 'low':
        return <Badge className="bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400">·ûè·û∑·ûÖ</Badge>
      default:
        return <Badge>·ûí·ûò·üí·ûò·ûè·û∂</Badge>
    }
  }

  const getActivityIcon = (type: string) => {
    switch (type) {
      case 'add':
        return <Plus className="h-4 w-4 text-green-600" />
      case 'edit':
        return <CheckCircle className="h-4 w-4 text-blue-600" />
      case 'create':
        return <Star className="h-4 w-4 text-purple-600" />
      case 'attendance':
        return <UserCheck className="h-4 w-4 text-orange-600" />
      case 'announcement':
        return <MessageSquare className="h-4 w-4 text-indigo-600" />
      default:
        return <Activity className="h-4 w-4 text-gray-600" />
    }
  }

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      {/* Error Display */}
      {error && (
        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
          <div className="flex items-center gap-2">
            <AlertCircle className="h-5 w-5 text-red-500" />
            <span className="text-red-700 font-medium">·ûÄ·üÜ·û†·ûª·ûü:</span>
            <span className="text-red-600">{error}</span>
            <button
              onClick={fetchDashboardData}
              className="ml-auto px-3 py-1 text-sm bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition-colors"
            >
              ·ûñ·üí·ûô·û∂·ûô·û∂·ûò·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè
            </button>
          </div>
        </div>
      )}

      {/* Loading State */}
      {loading && (
        <div className="text-center py-12">
          <Loader2 className="h-12 w-12 animate-spin mx-auto mb-4 text-primary" />
          <p className="text-lg text-muted-foreground">·ûÄ·üÜ·ûñ·ûª·ûÑ·ûë·û∂·ûâ·ûô·ûÄ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûï·üí·ûë·û∂·üÜ·ûÑ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ...</p>
        </div>
      )}

      {/* Dashboard Content - Only show when not loading */}
      {!loading && (
        <>
          {/* No Data State */}
          {students.length === 0 && safeUsers.length === 0 && (
            <div className="text-center py-12">
              <AlertCircle className="h-16 w-16 text-gray-400 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô</h3>
              <p className="text-gray-600 dark:text-gray-400 mb-4">
                ·ûü·ûº·ûò·ûñ·û∑·ûì·û∑·ûè·üí·ûô·ûÄ·û∂·ûö·ûè·ûó·üí·ûá·û∂·ûî·üã·ûë·üÖ·ûò·ûº·ûõ·ûä·üí·ûã·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô ·û¨·ûñ·üí·ûô·û∂·ûô·û∂·ûò·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè
              </p>
              <Button onClick={fetchDashboardData} variant="outline">
                ·ûñ·üí·ûô·û∂·ûô·û∂·ûò·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè
              </Button>
            </div>
          )}

          {/* Dashboard Content */}
          {students.length > 0 || safeUsers.length > 0 ? (
            <>


          {/* Stats Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-blue-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">·ûü·û∑·ûü·üí·ûü·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</CardTitle>
            <Users className="h-4 w-4 text-blue-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-blue-600">{dashboardStats.totalStudents}</div>
            <p className="text-xs text-muted-foreground">·ûü·û∑·ûü·üí·ûü·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·û∑·ûÄ·üí·ûü·û∂</p>
            <div className="flex items-center mt-2">
              <TrendingUp className="h-3 w-3 text-green-500 mr-1" />
              <span className="text-xs text-green-500">{dashboardStats.activeStudents} ·ûü·ûÄ·ûò·üí·ûò</span>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-green-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">·ûÇ·üí·ûö·ûº·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</CardTitle>
            <BookOpen className="h-4 w-4 text-green-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{dashboardStats.totalTeachers}</div>
            <p className="text-xs text-muted-foreground">·ûÇ·üí·ûö·ûº·ûî·ûÑ·üí·ûö·üÄ·ûì·ûü·ûÄ·ûò·üí·ûò</p>
            <div className="flex items-center mt-2">
              <TrendingUp className="h-3 w-3 text-green-500 mr-1" />
              <span className="text-xs text-green-500">{dashboardStats.totalCourses} ·ûê·üí·ûì·û∂·ûÄ·üã</span>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-purple-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">·ûü·û∑·ûü·üí·ûü·ûñ·ûº·ûÄ·üÇ</CardTitle>
            <Award className="h-4 w-4 text-purple-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-purple-600">{dashboardStats.activeStudents}</div>
            <p className="text-xs text-muted-foreground">·ûü·û∑·ûü·üí·ûü·ûü·ûÄ·ûò·üí·ûò</p>
            <div className="flex items-center mt-2">
              <TrendingUp className="h-3 w-3 text-green-500 mr-1" />
              <span className="text-xs text-green-500">{dashboardStats.totalStudents} ·ûü·ûö·ûª·ûî</span>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-orange-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">·ûä·üÜ·ûé·ûπ·ûÑ</CardTitle>
            <MessageSquare className="h-4 w-4 text-orange-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">{dashboardStats.totalAnnouncements}</div>
            <p className="text-xs text-muted-foreground">·ûä·üÜ·ûé·ûπ·ûÑ·ûü·ûÄ·ûò·üí·ûò</p>
            <div className="flex items-center mt-2">
              <Clock className="h-3 w-3 text-blue-500 mr-1" />
              <span className="text-xs text-blue-500">·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá: {dashboardStats.todayAttendance}</span>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Charts Section */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
        {/* Learning Quality Chart */}
        <div className="lg:col-span-2">
          <Card className="hover:shadow-lg transition-all duration-200">
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <BarChart3 className="h-5 w-5 text-blue-600" />
                <span className="text-lg">·ûÇ·ûª·ûé·ûó·û∂·ûñ·ûÄ·û∂·ûö·ûü·û∑·ûÄ·üí·ûü·û∂·ûè·û∂·ûò·ûÅ·üÇ</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart
                    data={learningQualityData}
                    margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
                  >
                    <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                    <XAxis dataKey="month" stroke="hsl(var(--muted-foreground))" />
                    <YAxis stroke="hsl(var(--muted-foreground))" />
                    <Tooltip 
                      formatter={(value, name) => {
                        if (name === 'quality') return [`${value}%`, '·ûÇ·ûª·ûé·ûó·û∂·ûñ']
                        if (name === 'averageScore') return [value, '·ûñ·û∑·ûì·üí·ûë·ûª·ûò·ûí·üí·ûô·ûò']
                        if (name === 'attendance') return [`${value}%`, '·ûú·ûè·üí·ûè·ûò·û∂·ûì']
                        return [value, name]
                      }}
                      labelFormatter={(label) => `·ûÅ·üÇ${label}`}
                      contentStyle={{
                        backgroundColor: 'hsl(var(--card))',
                        border: '1px solid hsl(var(--border))',
                        borderRadius: '8px',
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                        color: 'hsl(var(--foreground))'
                      }}
                    />
                    <Legend 
                      formatter={(value) => {
                        if (value === 'quality') return '·ûÇ·ûª·ûé·ûó·û∂·ûñ (%)'
                        if (value === 'averageScore') return '·ûñ·û∑·ûì·üí·ûë·ûª·ûò·ûí·üí·ûô·ûò'
                        if (value === 'attendance') return '·ûú·ûè·üí·ûè·ûò·û∂·ûì (%)'
                        return value
                      }}
                    />
                    <Bar dataKey="quality" fill="#3b82f6" name="·ûÇ·ûª·ûé·ûó·û∂·ûñ" radius={[4, 4, 0, 0]} />
                    <Bar dataKey="averageScore" fill="#10b981" name="·ûñ·û∑·ûì·üí·ûë·ûª·ûò·ûí·üí·ûô·ûò" radius={[4, 4, 0, 0]} />
                    <Bar dataKey="attendance" fill="#f59e0b" name="·ûú·ûè·üí·ûè·ûò·û∂·ûì" radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Attendance Pie Chart */}
        <div className="lg:col-span-1">
          <Card className="hover:shadow-lg transition-all duration-200">
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <UserCheck className="h-5 w-5 text-green-600" />
                <span className="text-lg">·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={realAttendanceData}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={({ name, percent }) => `${name} ${((percent || 0) * 100).toFixed(0)}%`}
                      outerRadius={80}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {realAttendanceData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>

      {/* Khmer Calendar and Recent Activity */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
        {/* Khmer Calendar */}
        <div className="lg:col-span-1">
          <KhmerCalendar compact={true} />
        </div>

        {/* Recent Activity */}
        <div className="lg:col-span-2">
          <Card className="hover:shadow-lg transition-all duration-200">
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Activity className="h-5 w-5 text-orange-600" />
                <span className="text-lg">·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ·ûê·üí·ûò·û∏·üó</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {recentActivities.map((activity) => (
                  <div key={activity.id} className="flex items-center space-x-4 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    <div className="flex-shrink-0">
                      {getActivityIcon(activity.type)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-gray-900 dark:text-white truncate">
                        {activity.action}
                      </p>
                      <p className="text-xs text-gray-500 dark:text-gray-400">
                        {activity.user} ‚Ä¢ {activity.time}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>
            </div>

      {/* Quick Actions Navigation */}
      <Card className="hover:shadow-lg transition-all duration-200">
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Activity className="h-5 w-5 text-blue-500" />
            <span>·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ·ûö·û†·üê·ûü</span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          <a href="/dashboard/academic-management" className="block">
              <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-blue-500 cursor-pointer">
                <CardContent className="p-4">
                  <div className="flex items-center space-x-3">
                    <BookOpen className="h-6 w-6 text-blue-500" />
                    <div>
                      <h3 className="font-semibold">·ûÄ·û∂·ûö·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûú·û∑·ûâ·üí·ûâ·û∂·ûî·ûì·ûî·ûè·üí·ûö</h3>
                      <p className="text-sm text-gray-600">·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûê·üí·ûì·û∂·ûÄ·üã ·ûì·û∑·ûÑ·ûò·ûª·ûÅ·ûú·û∑·ûá·üí·ûá·û∂</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </a>
            
                          <a href="/dashboard/add-student-class" className="block">
              <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-green-500 cursor-pointer">
                <CardContent className="p-4">
                  <div className="flex items-center space-x-3">
                    <UserPlus className="h-6 w-6 text-green-500" />
                    <div>
                      <h3 className="font-semibold">·ûî·ûì·üí·ûê·üÇ·ûò·ûü·û∑·ûü·üí·ûü·ûë·üÖ·ûÄ·üí·ûì·ûª·ûÑ·ûê·üí·ûì·û∂·ûÄ·üã</h3>
                      <p className="text-sm text-gray-600">·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûü·û∑·ûü·üí·ûü ·ûì·û∑·ûÑ·ûê·üí·ûì·û∂·ûÄ·üã</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </a>
            
                          <a href="/dashboard/users" className="block">
              <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-purple-500 cursor-pointer">
                <CardContent className="p-4">
                  <div className="flex items-center space-x-3">
                    <Users className="h-6 w-6 text-purple-500" />
                    <div>
                      <h3 className="font-semibold">·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·û¢·üí·ûì·ûÄ·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã</h3>
                      <p className="text-sm text-gray-600">·ûÇ·üí·ûö·ûº ·ûì·û∑·ûÑ·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </a>
            
                          <a href="/student-info" className="block">
              <Card className="hover:shadow-lg transition-all duration-200 border-l-4 border-l-orange-500 cursor-pointer">
                <CardContent className="p-4">
                  <div className="flex items-center space-x-3">
                    <GraduationCap className="h-6 w-6 text-orange-500" />
                    <div>
                      <h3 className="font-semibold">·ûñ·üê·ûè·üå·ûò·û∂·ûì·ûü·û∑·ûü·üí·ûü</h3>
                      <p className="text-sm text-gray-600">·ûò·ûæ·ûõ ·ûì·û∑·ûÑ·ûÄ·üÇ·ûî·üí·ûö·üÇ·ûñ·üê·ûè·üå·ûò·û∂·ûì</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </a>
          </div>
        </CardContent>
      </Card>

      {/* Announcements */}
      <Card className="hover:shadow-lg transition-all duration-200">
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle className="flex items-center space-x-2">
            <MessageSquare className="h-5 w-5 text-blue-600" />
            <span className="text-lg">·ûä·üÜ·ûé·ûπ·ûÑ·ûü·üÜ·ûÅ·û∂·ûì·üã·üó</span>
          </CardTitle>
          <Button 
            size="sm" 
            onClick={() => setShowAddForm(!showAddForm)} 
            className="flex items-center gap-2"
            variant="gradient"
          >
            {showAddForm ? (
              <>
                <XCircle className="h-4 w-4" />
                ·ûî·üÑ·üá·ûî·ûÑ·üã
              </>
            ) : (
              <>
                <Plus className="h-4 w-4" />
                ·ûî·ûì·üí·ûê·üÇ·ûò·ûä·üÜ·ûé·ûπ·ûÑ
              </>
            )}
          </Button>
        </CardHeader>
        <CardContent>
          {/* Add Announcement Form */}
          {showAddForm && (
            <div className="mb-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6">
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">·ûÖ·üÜ·ûé·ûÑ·ûá·ûæ·ûÑ*</label>
                    <Input
                      value={newAnnouncement.title}
                      onChange={(e) => setNewAnnouncement({...newAnnouncement, title: e.target.value})}
                      placeholder="·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûÖ·üÜ·ûé·ûÑ·ûá·ûæ·ûÑ·ûä·üÜ·ûé·ûπ·ûÑ"
                      className="h-12"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">·û¢·üí·ûì·ûÄ·ûì·û∑·ûñ·ûì·üí·ûí</label>
                    <Input
                      value={newAnnouncement.author}
                      onChange={(e) => setNewAnnouncement({...newAnnouncement, author: e.target.value})}
                      placeholder="·û¢·üí·ûì·ûÄ·ûï·üí·ûü·ûñ·üí·ûú·ûï·üí·ûü·û∂·ûô"
                      className="h-12"
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">·ûÅ·üí·ûõ·ûπ·ûò·ûü·û∂·ûö*</label>
                  <Textarea
                    value={newAnnouncement.content}
                    onChange={(e) => setNewAnnouncement({...newAnnouncement, content: e.target.value})}
                    placeholder="·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûÅ·üí·ûõ·ûπ·ûò·ûü·û∂·ûö·ûä·üÜ·ûé·ûπ·ûÑ"
                    rows={3}
                    className="resize-none"
                  />
                </div>
                <div className="flex justify-end space-x-3">
                  <Button 
                    variant="outline" 
                    onClick={() => {
                      setShowAddForm(false);
                      setNewAnnouncement({
                        title: '',
                        content: '',
                        author: '',
                        date: '',
                        priority: 'medium'
                      });
                    }}
                    className="border-gray-300 hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-800"
                  >
                    ·ûî·üÑ·üá·ûî·ûÑ·üã
                  </Button>
                  <Button 
                    onClick={handleAddAnnouncement}
                    variant="gradientGreen"
                  >
                    ·ûî·ûì·üí·ûê·üÇ·ûò·ûä·üÜ·ûé·ûπ·ûÑ
                  </Button>
                </div>
              </div>
            </div>
          )}
    
          {/* Announcements List */}
          <div className="space-y-4">
            {announcements.length > 0 ? (
              announcements.map((announcement) => (
                <div key={announcement.id} className="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all duration-200">
                  <div className="flex justify-between items-start gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h3 className="font-semibold text-gray-900 dark:text-white">
                          {announcement.title}
                        </h3>
                        {getPriorityBadge(announcement.priority)}
                      </div>
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        {announcement.content}
                      </p>
                      <div className="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
                        <span>üìÖ {announcement.date}</span>
                        {announcement.author && <span>üë§ {announcement.author}</span>}
                      </div>
                    </div>
                    <button 
                      onClick={() => handleDeleteAnnouncement(announcement.id)}
                      className="text-red-500 hover:text-red-700 transition-colors"
                      aria-label="·ûõ·ûª·ûî·ûä·üÜ·ûé·ûπ·ûÑ"
                    >
                      <TrashIcon className="h-4 w-4" />
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                <MessageSquare className="h-12 w-12 mx-auto mb-3 text-gray-300" />
                <p>·ûò·û∑·ûì·ûò·û∂·ûì·ûä·üÜ·ûé·ûπ·ûÑ·ûü·üÜ·ûÅ·û∂·ûì·üã·üó</p>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Outstanding Students */}
      <Card className="hover:shadow-lg transition-all duration-200">
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Star className="h-5 w-5 text-yellow-500" />
            <span className="text-lg">·ûü·û∑·ûü·üí·ûü·ûñ·ûº·ûÄ·üÇ</span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          {students.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              {students.slice(0, 4).map((student) => (
                <div key={student.studentId} className="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all duration-200">
                  <div className="flex items-center space-x-3 mb-3">
                    <div className="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                      {student.firstName.charAt(0)}
                    </div>
                    <div className="flex-1">
                      <p className="font-semibold text-gray-900 dark:text-white">
                        {student.firstName} {student.lastName}
                      </p>
                      <p className="text-sm text-gray-500 dark:text-gray-400">{student.class}</p>
                    </div>
                  </div>
                  <div className="space-y-2">
                    <p className="text-sm text-gray-600 dark:text-gray-400">·ûü·û∑·ûü·üí·ûü·ûü·ûÄ·ûò·üí·ûò</p>
                    <div className="flex items-center justify-between">
                      <span className="text-xs text-gray-500 dark:text-gray-400">·ûê·üí·ûì·û∂·ûÄ·üã {student.class}</span>
                      <Badge className="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400">
                        {student.status === 'ACTIVE' ? '·ûü·ûÄ·ûò·üí·ûò' : '·û¢·ûü·ûÄ·ûò·üí·ûò'}
                      </Badge>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-gray-500 dark:text-gray-400">
              <Users className="h-12 w-12 mx-auto mb-3 text-gray-300" />
              <p>·ûò·û∑·ûì·ûò·û∂·ûì·ûü·û∑·ûü·üí·ûü</p>
            </div>
          )}
        </CardContent>
      </Card>
            </>
          ) : null}
        </>
      )}
    </div>
  )
}